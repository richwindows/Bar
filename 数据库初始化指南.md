# 数据库初始化指南

## 🗄️ 问题说明

您遇到的错误信息表明Supabase数据库中缺少 `scan_time` 列：

```
ERROR: Could not find the 'scan_time' column of 'barcode_scans' in the schema cache
```

这是因为 `barcode_scans` 表中缺少 `scan_time` 列。

## 🔧 解决方案

### 方法一：在Supabase控制台中执行SQL

1. **登录Supabase控制台**
   - 访问 [https://supabase.com](https://supabase.com)
   - 登录您的账户
   - 选择您的项目

2. **打开SQL编辑器**
   - 在左侧菜单中点击 "SQL Editor"
   - 点击 "New query" 创建新查询

3. **执行修复语句**
   
   复制以下SQL语句并执行：

   ```sql
   -- 添加 scan_time 列到 barcode_scans 表（如果不存在）
   ALTER TABLE barcode_scans 
   ADD COLUMN IF NOT EXISTS scan_time TIMESTAMPTZ DEFAULT NOW();
   
   -- 创建索引
   CREATE INDEX IF NOT EXISTS idx_barcode_scans_scan_time ON barcode_scans(scan_time);
   
   -- 为现有数据设置默认的 scan_time 值（使用 created_at 的值）
   UPDATE barcode_scans 
   SET scan_time = created_at 
   WHERE scan_time IS NULL AND created_at IS NOT NULL;
   
   -- 删除重复的 created_at 列（可选，如果您想简化表结构）
   ALTER TABLE barcode_scans DROP COLUMN IF EXISTS created_at;
   
   -- 删除 created_at 相关的索引
   DROP INDEX IF EXISTS idx_barcode_scans_created_at;
   ```

4. **点击运行**
   - 点击 "Run" 按钮执行SQL
   - 确认所有语句都成功执行

### 方法二：使用完整的数据库脚本

如果您想要重新创建整个数据库结构，可以使用 `database_setup.sql` 文件：

1. 打开 `database_setup.sql` 文件
2. 复制全部内容
3. 在Supabase SQL编辑器中粘贴并执行

## 🔍 验证安装

执行以下查询来验证 `scan_time` 列是否添加成功：

```sql
-- 检查 barcode_scans 表是否包含 scan_time 列
SELECT column_name, data_type 
FROM information_schema.columns 
WHERE table_name = 'barcode_scans' 
AND column_name = 'scan_time';

-- 检查barcode_scans表结构
\d barcode_scans
```

## 🚀 重新测试应用程序

完成数据库修复后：

1. 重新启动您的扫码枪管理器应用程序
2. 尝试连接设备并进行扫描
3. 检查是否还有错误信息

## 📊 功能说明

### barcode_scans 表
- **用途**: 存储具体的扫描数据
- **字段**:
  - `id`: 扫描记录唯一标识符
  - `barcode_data`: 扫描到的条码数据
  - `device_port`: 扫描设备端口
  - `scan_time`: 扫描时间（统一的时间字段）

## 🔧 常见问题修复

### 问题: scan_time 字段缺失

如果您遇到以下错误：
```
ERROR: Could not find the 'scan_time' column of 'barcode_scans' in the schema cache
```

**解决方案**: 按照上述方法一的步骤执行修复

验证字段添加成功：
```sql
SELECT column_name, data_type 
FROM information_schema.columns 
WHERE table_name = 'barcode_scans' 
AND column_name = 'scan_time';
```

## ⚠️ 注意事项

1. **备份数据**: 如果您已有扫描数据，建议先备份
2. **权限检查**: 确保您的Supabase API密钥有足够的权限
3. **网络连接**: 确保应用程序能够访问Supabase服务
4. **字段兼容性**: 确保 `scan_time` 字段已正确添加

## 🆘 故障排除

### 常见问题

1. **权限错误**：确保您的 Supabase API 密钥具有足够的权限来修改表结构
2. **列已存在**：如果 `scan_time` 列已存在，SQL 命令会自动跳过（使用 `IF NOT EXISTS`）
3. **数据类型错误**：确保 `scan_time` 列的数据类型为 `TIMESTAMPTZ`
4. **删除列警告**：删除 `created_at` 列是可选的，如果您担心数据丢失，可以先备份数据

如果仍然遇到问题：

1. **检查API密钥**: 确认 `.env` 文件中的 `SUPABASE_KEY` 正确
2. **检查URL**: 确认 `SUPABASE_URL` 指向正确的项目
3. **查看日志**: 检查应用程序的详细错误日志
4. **测试连接**: 在Supabase控制台中测试API连接

完成这些步骤后，您的扫码枪管理器应该能够正常存储扫描数据了。